# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

def is_ci
  ENV["CI"] == "true" || ENV["GITHUB_ACTIONS"] == "true"
end

platform :ios do
  desc "Build and sign release IPA"
  lane :build_ipa do
    setup_ci if is_ci

    match(
      type: "development",
      readonly: is_ci
    )

    flutter_build(
      build: "ipa",
    )
  end

  desc "Build and upload PR preview to TestFlight Internal Testing"
  lane :upload_pr_preview do |options|
    build_number = options[:build_number] || 1
    pr_number = options[:pr_number] || ""
    pr_title = options[:pr_title] || "manual build"
    commit_sha = options[:commit_sha] || "manual build"
    commit_message = options[:commit_message] || "This is a manual build without PR information"

    setup_ci if is_ci

    sync_code_signing(
      type: "appstore",
      readonly: is_ci,
    )

    update_code_signing_settings(
      path: "ios/Runner.xcodeproj",
      sdk: "iphoneos*",
      code_sign_identity: "iPhone Distribution",
      profile_name: "match AppStore #{ENV["FASTLANE_APP_IDENTIFIER"]}",
    )

    # Build and create xcarchive without code signing
    archive_path = flutter_build(
      build: "ipa",
      build_number: build_number,
      build_args: ["--no-codesign"],
    )

    build_app(
      skip_build_archive: true,
      archive_path: archive_path,
      export_team_id: ENV["FASTLANE_TEAM_ID"],
      suppress_xcode_output: true,
    )

    app_store_connect_api_key(
      is_key_content_base64: true,
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: is_ci,
      changelog: "PR ##{pr_number}: #{pr_title}\n#{commit_sha} #{commit_message}",
    )
  end
end

desc "Build and upload release build to TestFlight"
  lane :upload_prod do |options|
    build_number = options[:build_number] || 1
    pr_number = options[:pr_number] || ""
    pr_title = options[:pr_title] || "manual build"
    commit_sha = options[:commit_sha] || "manual build"
    commit_message = options[:commit_message] || "This is a manual build without PR information"

    setup_ci if is_ci

    sync_code_signing(
      type: "appstore",
      readonly: is_ci,
    )

    update_code_signing_settings(
      path: "ios/Runner.xcodeproj",
      sdk: "iphoneos*",
      code_sign_identity: "iPhone Distribution",
      profile_name: "match AppStore #{ENV["FASTLANE_APP_IDENTIFIER"]}",
    )

    # Build and create xcarchive without code signing
    archive_path = flutter_build(
      build: "ipa",
      build_number: build_number,
      build_args: ["--no-codesign"],
    )

    build_app(
      skip_build_archive: true,
      archive_path: archive_path,
      export_team_id: ENV["FASTLANE_TEAM_ID"],
      suppress_xcode_output: true,
    )

    app_store_connect_api_key(
      is_key_content_base64: true,
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: is_ci,
      changelog: "#{pr_title}\n#{commit_sha} #{commit_message}",
    )
  end
end

platform :android do
  desc "Build and sign release APK"
  lane :build_apk do
    setup_keystore(skip_signing: true)

    flutter_build(
      build: "apk",
      build_args: ["--split-per-abi"]
    )
  end

  desc "Build and sign release AAB"
  lane :build_aab do
    setup_keystore(skip_signing: true)

    flutter_build(
      build: "appbundle",
    )
  end

  desc "Setup credential for environment"
  lane :setup_keystore do |options|
    skip_signing = options.fetch(:skip_signing, true)

    dirpath = match_keystore(skip_signing: skip_signing)
    keystore_base_path = File.dirname(File.dirname(dirpath))

    # Setup firebase configuration for android build
    firebase_conf_path = File.join(keystore_base_path, "firebase/google-services.json")
    
    if File.exist?(firebase_conf_path)
      dest_dir = File.expand_path("../android/app", __dir__)
      
      FileUtils.mkdir_p(dest_dir)
      FileUtils.cp(firebase_conf_path, File.join(dest_dir, "google-services.json"))
      
      UI.success("Successfully copied google-services.json to #{dest_dir}")
    else
      UI.error("Firebase config not found at #{firebase_conf_path}")
    end

    keystore_base_path
  end

  desc "Distribute development build to Firebase App Distribution (Android)"
  lane :upload_dev_firebase do |options|
    build_number = options[:build_number] || 1
    pr_number = options[:pr_number] || ""
    pr_title = options[:pr_title] || "manual build"
    commit_sha = options[:commit_sha] || "manual build"
    commit_message = options[:commit_message] || "This is a manual build without PR information"

    basepath = setup_keystore(skip_signing: true)
    firebase_service_account_path = File.join(basepath, ENV["FIREBASE_SERVICE_ACCOUNT_JSON_PATH"])

    output_file = flutter_build(
      build: "appbundle",
      build_number: build_number,
      build_args: ["--release"]
    )

    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID_ANDROID"],
      groups: "dev-tester", # Ensure this group exists in Firebase Console
      release_notes: "PR ##{pr_number}: #{pr_title}\n#{commit_sha} #{commit_message}",
      android_artifact_type: "AAB",
      android_artifact_path: output_file,
      service_credentials_file: firebase_service_account_path,
    )
  end

  desc "Distribute release build to Google Play Console"
  lane :upload_release_playstore do |options|
    build_number = options[:build_number] ||  1
    pr_number = options[:pr_number] || "unknown"
    pr_title = options[:pr_title] || "manual build"
    commit_sha = options[:commit_sha] || "manual build"
    commit_message = options[:commit_message] || "This is a manual build without PR information"

    basepath = setup_keystore(skip_signing: true)    
    supply_json_key_path = File.join(basepath, ENV["SUPPLY_JSON_KEY_PATH"])
    
    output_file = flutter_build(
      build: "appbundle",
      build_number: build_number,
      build_args: ["--release"]
    )

    # Create dynamic changelog files in the standard fastlane/metadata directory
    changelog_text = pr_number != "unknown" ? "PR ##{pr_number}: #{pr_title}\n#{commit_sha} #{commit_message}" : "#{pr_title}\n#{commit_sha} #{commit_message}"
    ["zh-TW"].each do |locale|
      path = "metadata/android/#{locale}/changelogs"
      FileUtils.mkdir_p(path)
      File.write("#{path}/default.txt", changelog_text)
      File.write("#{path}/#{build_number}.txt", changelog_text)
    end

    upload_to_play_store(
      package_name: ENV["FASTLANE_APP_IDENTIFIER"],
      track: "internal",
      aab: output_file,
      json_key: supply_json_key_path,
      skip_upload_metadata: false,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: false
    )
  end  
end
