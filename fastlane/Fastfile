# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

platform :ios do
  desc "Build and upload PR preview to TestFlight Internal Testing"
  lane :upload_pr_preview do |options|
    build_number = options[:build_number] || 1
    pr_number = options[:pr_number] || ""
    pr_title = options[:pr_title] || "manual build"
    commit_sha = options[:commit_sha] || "manual build"
    commit_message = options[:commit_message] || "This is a manual build without PR information"

    setup_ci if is_ci

    sync_code_signing(
      type: "appstore",
      readonly: is_ci,
    )

    update_code_signing_settings(
      path: "ios/Runner.xcodeproj",
      sdk: "iphoneos*",
      code_sign_identity: "iPhone Distribution",
      profile_name: "match AppStore #{ENV["FASTLANE_APP_IDENTIFIER"]}",
    )

    # Build and create xcarchive without code signing
    archive_path = flutter_build(
      build: "ipa",
      build_number: build_number,
      build_args: ["--no-codesign"],
    )

    build_app(
      skip_build_archive: true,
      archive_path: archive_path,
      export_team_id: ENV["FASTLANE_TEAM_ID"],
      suppress_xcode_output: true,
    )

    app_store_connect_api_key(
      is_key_content_base64: true,
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: is_ci,
      changelog: "PR ##{pr_number}: #{pr_title}\n#{commit_sha} #{commit_message}",
    )
  end
  
  desc "Build and upload release build to TestFlight"
  lane :upload_prod do |options|
    build_number = options[:build_number] || 1
    pr_number = options[:pr_number] || ""
    pr_title = options[:pr_title] || "manual build"
    commit_sha = options[:commit_sha] || "manual build"
    commit_message = options[:commit_message] || "This is a manual build without PR information"

    setup_ci if is_ci

    sync_code_signing(
      type: "appstore",
      readonly: is_ci,
    )

    update_code_signing_settings(
      path: "ios/Runner.xcodeproj",
      sdk: "iphoneos*",
      code_sign_identity: "iPhone Distribution",
      profile_name: "match AppStore #{ENV["FASTLANE_APP_IDENTIFIER"]}",
    )

    # Build and create xcarchive without code signing
    archive_path = flutter_build(
      build: "ipa",
      build_number: build_number,
      build_args: ["--no-codesign"],
    )

    build_app(
      skip_build_archive: true,
      archive_path: archive_path,
      export_team_id: ENV["FASTLANE_TEAM_ID"],
      suppress_xcode_output: true,
    )

    app_store_connect_api_key(
      is_key_content_base64: true,
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: is_ci,
      changelog: "#{pr_title}\n#{commit_sha} #{commit_message}",
    )
  end
end

platform :android do
  desc "Setup credentials for environment"
  lane :setup_keystore do |options|
    skip_signing = options.fetch(:skip_signing, true)

    dirpath = match_keystore(skip_signing: skip_signing)
    keystore_base_path = File.dirname(File.dirname(dirpath))

    # Setup firebase configuration for android build
    firebase_conf_path = File.join(keystore_base_path, "firebase/google-services.json")
    
    if File.exist?(firebase_conf_path)
      dest_dir = File.expand_path("../android/app", __dir__)
      
      FileUtils.mkdir_p(dest_dir)
      FileUtils.cp(firebase_conf_path, File.join(dest_dir, "google-services.json"))
      
      UI.success("Successfully copied google-services.json to #{dest_dir}")
    else
      UI.error("Firebase config not found at #{firebase_conf_path}")
    end

    keystore_base_path
  end

  desc "Distribute development build to Firebase App Distribution (Android)"
  lane :upload_dev_firebase do |options|
    build_number = options[:build_number] || 1
    pr_number = options[:pr_number] || ""
    pr_title = options[:pr_title] || "manual build"
    commit_sha = options[:commit_sha] || "manual build"
    commit_message = options[:commit_message] || "This is a manual build without PR information"

    basepath = setup_keystore(skip_signing: true)

    service_account_rel = ENV["FIREBASE_SERVICE_ACCOUNT_JSON_PATH"]
    if service_account_rel.nil? || service_account_rel.empty?
      UI.user_error!("FIREBASE_SERVICE_ACCOUNT_JSON_PATH is not set or empty")
    end

    basepath_expanded = File.expand_path(basepath)
    firebase_service_account_path = File.expand_path(service_account_rel, basepath_expanded)

    unless firebase_service_account_path.start_with?(basepath_expanded + File::SEPARATOR) || firebase_service_account_path == basepath_expanded
      UI.user_error!("Invalid FIREBASE_SERVICE_ACCOUNT_JSON_PATH; must point inside #{basepath_expanded}")
    end

    output_file = flutter_build(
      build: "appbundle",
      build_number: build_number,
      build_args: ["--release"]
    )

    release = firebase_app_distribution(
      groups: "dev-tester", # Ensure this group exists in Firebase Console
      release_notes: "PR ##{pr_number}: #{pr_title}\n#{commit_sha} #{commit_message}",
      android_artifact_type: "AAB",
      android_artifact_path: output_file,
      service_credentials_file: firebase_service_account_path,
    )

    if ENV["GITHUB_OUTPUT"]
      File.open(ENV["GITHUB_OUTPUT"], "a") do |f|
        f.puts "testing_uri=#{release[:testingUri]}"
      end
    end
  end

  desc "Distribute release build to Google Play Console"
  lane :upload_release_playstore do |options|
    build_number = options[:build_number] || 1
    pr_number = options[:pr_number] || ""
    pr_title = options[:pr_title] || "manual build"
    commit_sha = options[:commit_sha] || "manual build"
    commit_message = options[:commit_message] || "This is a manual build without PR information"

    basepath = setup_keystore(skip_signing: true) 

    supply_json_key_rel = ENV["SUPPLY_JSON_KEY_PATH"]
    if supply_json_key_rel.nil? || supply_json_key_rel.empty?
      UI.user_error!("SUPPLY_JSON_KEY_PATH is not set or empty")
    end

    basepath_expanded = File.expand_path(basepath)
    supply_json_key_path = File.expand_path(supply_json_key_rel, basepath_expanded)

    unless supply_json_key_path.start_with?(basepath_expanded + File::SEPARATOR) || supply_json_key_path == basepath_expanded
      UI.user_error!("Invalid SUPPLY_JSON_KEY_PATH; must point inside #{basepath_expanded}")
    end

    
    output_file = flutter_build(
      build: "appbundle",
      build_number: build_number,
      build_args: ["--release"]
    )

    # Create dynamic changelog files in the standard fastlane/metadata directory
    changelog_text = pr_number != "" ? "PR ##{pr_number}: #{pr_title}\n#{commit_sha} #{commit_message}" : "#{pr_title}\n#{commit_sha} #{commit_message}"
    ["zh-TW"].each do |locale|
      path = "metadata/android/#{locale}/changelogs"
      FileUtils.mkdir_p(path)
      File.write("#{path}/default.txt", changelog_text)
      File.write("#{path}/#{build_number}.txt", changelog_text)
    end

    upload_to_play_store(
      package_name: ENV["FASTLANE_APP_IDENTIFIER"],
      track: "internal",
      aab: output_file,
      json_key: supply_json_key_path,
      skip_upload_metadata: false,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: false
    )
  end  
end
