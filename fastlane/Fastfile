# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

def changelog(pr_number, pr_title, commit_sha, commit_message)
  prefix = pr_number.to_s.empty? ? pr_title : "PR ##{pr_number}: #{pr_title}"
  "#{prefix}\n#{commit_sha} #{commit_message}"
end

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do |options|
    build_number = options[:build_number] || 1
    pr_number = options[:pr_number] || ""
    pr_title = options[:pr_title] || "manual build"
    commit_sha = options[:commit_sha] || "manual build"
    commit_message = options[:commit_message] || "This is a manual build without PR information"
    skip_upload = options[:skip_upload].to_s == "true"

    setup_ci if is_ci

    sync_code_signing(
      type: "appstore",
      readonly: is_ci,
    )

    update_code_signing_settings(
      path: "ios/Runner.xcodeproj",
      sdk: "iphoneos*",
      code_sign_identity: "iPhone Distribution",
      profile_name: "match AppStore #{ENV["FASTLANE_APP_IDENTIFIER"]}",
    )

    # Build and create xcarchive without code signing
    archive_path = flutter_build(
      build: "ipa",
      build_number: build_number,
      build_args: ["--no-codesign"],
    )

    build_app(
      skip_build_archive: true,
      archive_path: archive_path,
      export_team_id: ENV["FASTLANE_TEAM_ID"],
      suppress_xcode_output: true,
    )

    next if skip_upload

    app_store_connect_api_key(
      is_key_content_base64: true,
    )

    changelog = changelog(pr_number, pr_title, commit_sha, commit_message)

    upload_to_testflight(
      skip_waiting_for_build_processing: is_ci,
      changelog: changelog,
    )
  end
end

platform :android do
  desc "Build and upload PR preview to Firebase App Distribution"
  lane :preview do |options|
    build_number = options[:build_number] || 1
    pr_number = options[:pr_number] || ""
    pr_title = options[:pr_title] || "manual build"
    commit_sha = options[:commit_sha] || "manual build"
    commit_message = options[:commit_message] || "This is a manual build without PR information"
    skip_upload = options[:skip_upload].to_s == "true"

    Dir.chdir("..") { sh("dart", "run", "tool/credentials.dart", "fetch") }

    output_file = flutter_build(
      build: "appbundle",
      build_number: build_number,
    )

    next if skip_upload

    changelog = changelog(pr_number, pr_title, commit_sha, commit_message)

    release = firebase_app_distribution(
      groups: "dev-tester",
      release_notes: changelog,
      android_artifact_type: "AAB",
      android_artifact_path: output_file,
      service_credentials_file: File.expand_path("../service-account.json", __dir__),
    )

    if ENV["GITHUB_OUTPUT"]
      File.open(ENV["GITHUB_OUTPUT"], "a") do |f|
        f.puts "testing_uri=#{release[:testingUri]}"
      end
    end
  end

  desc "Build and upload to Google Play Console"
  lane :release do |options|
    build_number = options[:build_number] || 1
    pr_number = options[:pr_number] || ""
    pr_title = options[:pr_title] || "manual build"
    commit_sha = options[:commit_sha] || "manual build"
    commit_message = options[:commit_message] || "This is a manual build without PR information"
    skip_upload = options[:skip_upload].to_s == "true"

    Dir.chdir("..") { sh("dart", "run", "tool/credentials.dart", "fetch") }

    output_file = flutter_build(
      build: "appbundle",
      build_number: build_number,
    )

    next if skip_upload

    # Create dynamic changelog files in the standard fastlane/metadata directory
    changelog_text = changelog(pr_number, pr_title, commit_sha, commit_message)
    ["zh-TW"].each do |locale|
      path = "metadata/android/#{locale}/changelogs"
      FileUtils.mkdir_p(path)
      File.write("#{path}/#{build_number}.txt", changelog_text)
    end

    upload_to_play_store(
      package_name: ENV["FASTLANE_APP_IDENTIFIER"],
      track: "internal",
      aab: output_file,
      json_key: File.expand_path("../service-account.json", __dir__),
      skip_upload_metadata: false,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: false
    )
  end
end
